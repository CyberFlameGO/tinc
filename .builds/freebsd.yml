image: freebsd/13.x

packages:
  - autotools
  - openssl
  - lzo2
  - liblz4
  - ncurses
  - miniupnpc
  - readline
  - texinfo
  - vde2
  - libgcrypt
  - llvm12
  - py38-pip

environment:
  CFLAGS: -I/usr/local/include -L/usr/local/lib

sources:
  - https://github.com/gsliepen/tinc

tasks:
  - configure: |
      cd tinc
      autoreconf -fsi
      ./configure --enable-miniupnpc --enable-vde

  - build: |
      cd tinc
      make -j$(sysctl -n hw.ncpu)

  - test: |
      cd tinc
      make check-recursive VERBOSE=1

  - lint: |
      export PATH=$PATH:$HOME/.local/bin
      pip install --user compiledb
      cd tinc
      compiledb -n make check
      find src \
        ! '(' -path src/solaris -prune ')' \
        ! '(' -path src/mingw   -prune ')' \
        ! '(' -path src/linux   -prune ')' \
        ! -name tunemu.c \
        -name '*.c' \
        -exec clang-tidy12 --header-filter='.*' '{}' +
